//1ã€å¤©ä¹¦ç‰ˆ7.0é‡æ„ç‰ˆï¼Œå¢å¼ºä¼ è¾“ç¨³å®šæ€§ï¼Œ0å¼‚å¸¸é”™è¯¯ç‡
//2ã€æ”¯æŒåä»£å¼€å…³ï¼Œç§é’¥å¼€å…³ï¼Œå…¨å±€åˆ†æ®µå¼€å…³ï¼Œè®¢é˜…éšè—å¼€å…³åŠŸèƒ½ï¼Œclashç§é’¥é˜²æ­¢è¢«è–…è¯·æ±‚æ•°
//4ã€æ”¯æŒSOCKS5ï¼Œæ”¯æŒå¤–éƒ¨ç¯å¢ƒå˜é‡ï¼Œå˜é‡åã€SOCKS5ã€‘ï¼ŒSOCKS5å’ŒåŸå§‹åä»£åªèƒ½äºŒé€‰ä¸€ï¼ŒSOCKS5æ¡æ‰‹è¿‡ç¨‹è¾ƒä¸ºç¹æ‚ï¼Œå»ºè®®æœ‰é«˜é€Ÿç¨³å®šSOCKS5çš„äººä½¿ç”¨ï¼Œä¸ºäº†æ–¹ä¾¿åˆ‡æ¢å¢åŠ äº†ä¸€ä¸ªå¤–éƒ¨å˜é‡ã€SOCKS5OPENã€‘ï¼Œtrueæ‰“å¼€å’Œfalseå…³é—­
//5ã€æ”¯æŒS5å…¨å±€åä»£ï¼Œå…¨å±€åä»£å¤–éƒ¨ç¯å¢ƒå˜é‡åã€SOCKS5GLOBALã€‘ï¼Œtrueå’Œfalse
//6ã€ä¸ç”¨åœ¨æ„é‚£äº›å¥‡æ€ªçš„å˜é‡åï¼Œæ ¹æ®åé¢æ³¨é‡Šçš„å¤‡æ³¨å»æ”¹ï¼Œå¤§æ¦‚ä¹Ÿå°±é…ç½®åŒºå—çœ‹ä¸€ä¸‹å¤‡æ³¨å°±è¡Œï¼Œclashé…ç½®åœ¨åº•éƒ¨ï¼Œæ‡‚çš„å¯ä»¥æ ¹æ®è‡ªèº«éœ€æ±‚ä¿®æ”¹
//7ã€çº¯æ‰‹æ“é…ç½®ï¼Œå»é™¤ä»»ä½•APIå¤–é“¾ï¼Œç›´æ¥æ”¹å¥½äº†éƒ¨ç½²å°±è¡Œï¼Œè¿™æ ·å®‰å…¨æ€§å²æ— å‰ä¾‹
//8ã€é€šç”¨è®¢é˜…ä¸æ”¯æŒç§é’¥åŠŸèƒ½ï¼Œä½¿ç”¨é€šç”¨è®¢é˜…éœ€å…³é—­ç§é’¥åŠŸèƒ½å†è®¢é˜…èŠ‚ç‚¹ï¼ŒCFä¸æ”¯æŒè‡ªèº«1.1.1.1çš„DNSè§£æï¼Œå¦‚æœæ— æ³•è¿é€šå¯ä»¥æ£€æŸ¥å®¢æˆ·ç«¯DNSè®¾ç½®
//9ã€ç”±äºæœ¬äººä»…ä½¿ç”¨openclashå’Œclash metaï¼Œå…¶ä»–å¹³å°è½¯ä»¶å‡æœªæµ‹è¯•ï¼Œè¯·è‡ªè¡Œæµ‹è¯•ç ”ç©¶ï¼Œè¦æ˜¯ä¸èƒ½ç”¨å°±ç®—äº†ï¼Œä¸è´Ÿè´£æ”¹è¿›ï¼Œç»§ç»­æ¦‚ä¸è´Ÿè´£^_^
//10ã€ç”±äºæœ¬äººçº¯èœï¼Œå¾ˆå¤šä»£ç è§£é‡Šéƒ½æ˜¯æ ¹æ®è‡ªå·±çš„ç†è§£çç¼–çš„ï¼Œä¸“ä¸šçš„æ— è§†å°±å¥½ï¼Œå•çº¯ä¸ºäº†å¸®åŠ©å°ç™½ç†è§£ä»£ç å¤§è‡´åŸç†^_^
//11ã€é‡è¦ï¼ï¼ï¼è¯·å¤§å®¶ä¸è¦å‘å¤§ç¾¤ï¼Œè¦æ˜¯å› ä¸ºä¼ æ’­å¹¿æ³›è¢«å°äº†æœ¬äººæŠ€æœ¯æœ‰é™æ²¡æœ‰èƒ½åŠ›è¿›è¡Œä¿®å¤

import { connect } from 'cloudflare:sockets';
//////////////////////////////////////////////////////////////////////////é…ç½®åŒºå—////////////////////////////////////////////////////////////////////////
let å“å‘€å‘€è¿™æ˜¯æˆ‘çš„IDå•Š = "sub"; //å®é™…ä¸Šè¿™æ˜¯ä½ çš„è®¢é˜…è·¯å¾„ï¼Œæ”¯æŒä»»æ„å¤§å°å†™å­—æ¯å’Œæ•°å­—ï¼Œ[åŸŸå/ID]è¿›å…¥è®¢é˜…é¡µé¢
let å“å‘€å‘€è¿™æ˜¯æˆ‘çš„VLå¯†é’¥ = "d39b279d-e22b-433d-b57c-aa72c79ad63c"; //è¿™æ˜¯çœŸå®çš„UUIDï¼Œé€šç”¨è®¢é˜…ä¼šè¿›è¡ŒéªŒè¯ï¼Œå»ºè®®ä¿®æ”¹ä¸ºè‡ªå·±çš„è§„èŒƒåŒ–UUID

let ç§é’¥å¼€å…³ = false //æ˜¯å¦å¯ç”¨ç§é’¥åŠŸèƒ½ï¼Œtrueå¯ç”¨ï¼Œfalseä¸å¯ç”¨ï¼Œå› ä¸ºç§é’¥åŠŸèƒ½åªæ”¯æŒclashï¼Œå¦‚æœæ‰“ç®—ä½¿ç”¨é€šç”¨è®¢é˜…åˆ™éœ€å…³é—­ç§é’¥åŠŸèƒ½
let å’¦è¿™æ˜¯æˆ‘çš„ç§é’¥å“ = ""; //è¿™æ˜¯ä½ çš„ç§é’¥ï¼Œæé«˜éšç§˜æ€§å®‰å…¨æ€§ï¼Œå°±ç®—åˆ«äººæ‰«åˆ°ä½ çš„åŸŸåä¹Ÿæ— æ³•é“¾æ¥ï¼Œå†ä¹Ÿä¸æ€•åˆ«äººè–…è¯·æ±‚æ•°äº†^_^

let éšè—è®¢é˜… = false //é€‰æ‹©æ˜¯å¦éšè—è®¢é˜…é¡µé¢ï¼Œfalseä¸éšè—ï¼Œtrueéšè—ï¼Œå½“ç„¶éšè—åè‡ªå·±ä¹Ÿæ— æ³•è®¢é˜…ï¼Œå› ä¸ºé…ç½®å›ºå®šï¼Œé€‚åˆè‡ªå·±è®¢é˜…åå°±éšè—ï¼Œé˜²æ­¢è¢«çˆ¬è®¢é˜…ï¼Œå¹¶ä¸”å¯ä»¥åˆ°ä¸‹æ–¹æ·»åŠ å˜²è®½è¯­^_^
let å˜²è®½è¯­ = "å“å‘€ä½ æ‰¾åˆ°äº†æˆ‘ï¼Œä½†æ˜¯æˆ‘å°±æ˜¯ä¸ç»™ä½ çœ‹ï¼Œæ°”ä¸æ°”ï¼Œå˜¿å˜¿å˜¿" //éšè—è®¢é˜…åï¼ŒçœŸå®çš„è®¢é˜…é¡µé¢å°±ä¼šæ˜¾ç¤ºè¿™æ®µè¯ï¼Œæƒ³å†™å•¥å†™å•¥

let æˆ‘çš„ä¼˜é€‰ = [
  'www.visa.com',
] //æ ¼å¼127.0.0.1:443#US@notlsæˆ–[2606:4700:3030:0:4563:5696:a36f:cdc5]:2096#USï¼Œå¦‚æœ#USä¸å¡«åˆ™ä½¿ç”¨ç»Ÿä¸€åç§°ï¼Œå¦‚æœ@notlsä¸å¡«åˆ™é»˜è®¤ä½¿ç”¨TLSï¼Œæ¯è¡Œä¸€ä¸ªï¼Œå¦‚æœä¸å¡«ä»»ä½•èŠ‚ç‚¹ä¼šç”Ÿæˆä¸€ä¸ªé»˜è®¤è‡ªèº«åŸŸåçš„å°é»„äº‘èŠ‚ç‚¹
let æˆ‘çš„ä¼˜é€‰TXT = ['https://raw.cfip.nyc.mn/eliangwww/eliang_clash/refs/heads/main/data/ipss.txt?token=12123',
              'https://raw.cfip.nyc.mn/eliangwww/eliang_clash/refs/heads/main/data/ips.txt?token=12123'
              ] //ä¼˜é€‰TXTè·¯å¾„ï¼Œè¡¨è¾¾æ ¼å¼ä¸ä¸Šè¿°ç›¸åŒï¼Œä½¿ç”¨TXTæ—¶è„šæœ¬å†…éƒ¨å¡«å†™çš„èŠ‚ç‚¹æ— æ•ˆï¼ŒäºŒé€‰ä¸€

let å¯ç”¨åä»£åŠŸèƒ½ = true //é€‰æ‹©æ˜¯å¦å¯ç”¨åä»£åŠŸèƒ½ã€æ€»å¼€å…³ã€‘ï¼Œfalseï¼Œtrueï¼Œç°åœ¨ä½ å¯ä»¥è‡ªç”±çš„é€‰æ‹©æ˜¯å¦å¯ç”¨åä»£åŠŸèƒ½äº†
let åä»£IP = 'ts.hpc.tw' //åä»£IPæˆ–åŸŸåï¼Œåä»£IPç«¯å£ä¸€èˆ¬æƒ…å†µä¸‹ä¸ç”¨å¡«å†™ï¼Œå¦‚æœä½ éè¦ç”¨éæ ‡åä»£çš„è¯ï¼Œå¯ä»¥å¡«'ts.hpc.tw:443'è¿™æ ·

let å¯ç”¨SOCKS5åä»£ = false //å¦‚æœå¯ç”¨æ­¤åŠŸèƒ½ï¼ŒåŸå§‹åä»£å°†å¤±æ•ˆ
let å¯ç”¨SOCKS5å…¨å±€åä»£ = false //é€‰æ‹©æ˜¯å¦å¯ç”¨SOCKS5å…¨å±€åä»£ï¼Œå¯ç”¨åæ‰€æœ‰è®¿é—®éƒ½æ˜¯S5çš„è½åœ°ã€æ— è®ºä½ å®¢æˆ·ç«¯é€‰ä»€ä¹ˆèŠ‚ç‚¹ã€‘ï¼Œè®¿é—®è·¯å¾„æ˜¯å®¢æˆ·ç«¯--CF--SOCKS5ï¼Œå½“ç„¶å¯ç”¨æ­¤åŠŸèƒ½åå»¶è¿Ÿ=CF+SOCKS5ï¼Œå¸¦å®½å–å†³äºSOCKS5çš„å¸¦å®½ï¼Œä¸å†äº«å—CFé«˜é€Ÿå’Œéšæ—¶æ»¡å¸¦å®½çš„å¾…é‡
let æˆ‘çš„SOCKS5è´¦å· = '' //æ ¼å¼'è´¦å·:å¯†ç @åœ°å€:ç«¯å£'

let æˆ‘çš„èŠ‚ç‚¹åå­— = 'å¤©ä¹¦' //è‡ªå·±çš„èŠ‚ç‚¹åå­—ã€ç»Ÿä¸€åç§°ã€‘

let ä¼ªè£…ç½‘é¡µ = 'www.cfip.nyc.mn' //å¡«å…¥ä¼ªè£…ç½‘é¡µï¼Œæ ¼å¼'www.youku.com'ï¼Œå»ºè®®ç”¨å°ç«™ä¼ªè£…ï¼Œæ¯”è¾ƒé è°±

let å¯ç”¨æœ¬åœ°ç¼“å­˜ = true //å¯ç”¨åæ•°æ®åœ¨CFä¸Šç¼“å­˜æš‚ç•™ï¼Œæå‡ä¼ è¾“å¯é æ€§ï¼Œæç€ç©çš„ï¼Œè‡ªè¡Œç ”ç©¶æ˜¯å¦å¼€å¯

let TCPå¹¶å‘æ•° = 1; //å¹¶å‘è®¿é—®ï¼Œé¡¾åæ€ä¹‰ï¼Œæç€ç©çš„ï¼Œä¸€èˆ¬è®¾ç½®1å°±è¡Œ

let é™é€Ÿç­‰çº§ = 0 //é™é€Ÿç­‰çº§ï¼Œä¸»åŠ¨é™åˆ¶é€Ÿåº¦ä»¥è¾¾åˆ°æŸç§å¢å¼ºç¨³å®šæ€§éœ€æ±‚ï¼Œæ•°å€¼è¶Šå¤§è¶Šæ…¢ï¼Œ0ä¸ºä¸é™é€Ÿ
//////////////////////////////////////////////////////////////////////////ç½‘é¡µå…¥å£////////////////////////////////////////////////////////////////////////
export default {
  async fetch(è®¿é—®è¯·æ±‚, env) {
    const è¯»å–æˆ‘çš„è¯·æ±‚æ ‡å¤´ = è®¿é—®è¯·æ±‚.headers.get('Upgrade');
    const url = new URL(è®¿é—®è¯·æ±‚.url);
    if (!è¯»å–æˆ‘çš„è¯·æ±‚æ ‡å¤´ || è¯»å–æˆ‘çš„è¯·æ±‚æ ‡å¤´ !== 'websocket') {
      if (æˆ‘çš„ä¼˜é€‰TXT) {
        const è¯»å–ä¼˜é€‰æ–‡æœ¬ = await Promise.all(æˆ‘çš„ä¼˜é€‰TXT.map(url => fetch(url).then(response => response.text())));
        const è½¬æ¢ä¼˜é€‰æ–‡æœ¬ = è¯»å–ä¼˜é€‰æ–‡æœ¬.flat();
        const ä¼˜é€‰èŠ‚ç‚¹ = è½¬æ¢ä¼˜é€‰æ–‡æœ¬
    .map(line => line.split('\n').map(line => line.trim()).filter(line => line)) // Split and clean each line
    .flat();
        æˆ‘çš„ä¼˜é€‰ = ä¼˜é€‰èŠ‚ç‚¹ || æˆ‘çš„ä¼˜é€‰
      }
      switch (url.pathname) {
        case `/${å“å‘€å‘€è¿™æ˜¯æˆ‘çš„IDå•Š}/panel`: {
          const è®¢é˜…é¡µé¢ = ç»™æˆ‘è®¢é˜…é¡µé¢(å“å‘€å‘€è¿™æ˜¯æˆ‘çš„IDå•Š, è®¿é—®è¯·æ±‚.headers.get('Host'));
          return new Response(`${è®¢é˜…é¡µé¢}`, {
            status: 200,
            headers: { "Content-Type": "text/html;charset=utf-8" }
          });
        }
        case `/${å“å‘€å‘€è¿™æ˜¯æˆ‘çš„IDå•Š}/eliangwww`: {
          if (éšè—è®¢é˜…) {
            return new Response (`${å˜²è®½è¯­}`, {
              status: 200,
              headers: { "Content-Type": "text/plain;charset=utf-8" }
            });
          } else {
            const é€šç”¨é…ç½®æ–‡ä»¶ = ç»™æˆ‘é€šç”¨é…ç½®æ–‡ä»¶(è®¿é—®è¯·æ±‚.headers.get('Host'));
            return new Response(`${é€šç”¨é…ç½®æ–‡ä»¶}`, {
              status: 200,
              headers: { "Content-Type": "text/plain;charset=utf-8" }
            });
          }
        }
        case `/${å“å‘€å‘€è¿™æ˜¯æˆ‘çš„IDå•Š}`: {
          if (éšè—è®¢é˜…) {
            return new Response (`${å˜²è®½è¯­}`, {
              status: 200,
              headers: { "Content-Type": "text/plain;charset=utf-8" }
            });
          } else {
            const å°çŒ«å’ªé…ç½®æ–‡ä»¶ = ç»™æˆ‘å°çŒ«å’ªé…ç½®æ–‡ä»¶(è®¿é—®è¯·æ±‚.headers.get('Host'));
            return new Response(`${å°çŒ«å’ªé…ç½®æ–‡ä»¶}`, {
              status: 200,
              headers: { "Content-Type": "text/plain;charset=utf-8" }
            });
          }
        }
        default:
          url.hostname = ä¼ªè£…ç½‘é¡µ;
          url.protocol = 'https:';
          è®¿é—®è¯·æ±‚ = new Request(url, è®¿é—®è¯·æ±‚);
          return fetch(è®¿é—®è¯·æ±‚);
      }
    } else if (è¯»å–æˆ‘çš„è¯·æ±‚æ ‡å¤´ === 'websocket'){
      åä»£IP = env.PROXYIP || åä»£IP;
      æˆ‘çš„SOCKS5è´¦å· = env.SOCKS5 || æˆ‘çš„SOCKS5è´¦å·;
      å¯ç”¨SOCKS5åä»£ = (env.SOCKS5OPEN === 'true') ? true : (env.SOCKS5OPEN === 'false' ? false : å¯ç”¨SOCKS5åä»£);
      å¯ç”¨SOCKS5å…¨å±€åä»£ = (env.SOCKS5GLOBAL === 'true') ? true : (env.SOCKS5GLOBAL === 'false' ? false : å¯ç”¨SOCKS5å…¨å±€åä»£);
      if (ç§é’¥å¼€å…³) {
        const éªŒè¯æˆ‘çš„ç§é’¥ = è®¿é—®è¯·æ±‚.headers.get('my-key')
        if (éªŒè¯æˆ‘çš„ç§é’¥ === å’¦è¿™æ˜¯æˆ‘çš„ç§é’¥å“) {
          return await å‡çº§WSè¯·æ±‚(è®¿é—®è¯·æ±‚);
        }
      } else {
        return await å‡çº§WSè¯·æ±‚(è®¿é—®è¯·æ±‚);
      }
    }
  }
};
////////////////////////////////////////////////////////////////////////è„šæœ¬ä¸»è¦æ¶æ„//////////////////////////////////////////////////////////////////////
//ç¬¬ä¸€æ­¥ï¼Œè¯»å–å’Œæ„å»ºåŸºç¡€è®¿é—®ç»“æ„
async function å‡çº§WSè¯·æ±‚(è®¿é—®è¯·æ±‚) {
  const åˆ›å»ºWSæ¥å£ = new WebSocketPair();
  const [å®¢æˆ·ç«¯, WSæ¥å£] = Object.values(åˆ›å»ºWSæ¥å£);
  WSæ¥å£.accept();
  const è¯»å–æˆ‘çš„åŠ å¯†è®¿é—®å†…å®¹æ•°æ®å¤´ = è®¿é—®è¯·æ±‚.headers.get('sec-websocket-protocol');
  const è§£å¯†æ•°æ® = ä½¿ç”¨64ä½åŠ è§£å¯†(è¯»å–æˆ‘çš„åŠ å¯†è®¿é—®å†…å®¹æ•°æ®å¤´); //è§£å¯†ç›®æ ‡è®¿é—®æ•°æ®ï¼Œä¼ é€’ç»™TCPæ¡æ‰‹è¿›ç¨‹
  const { TCPæ¥å£, å†™å…¥åˆå§‹æ•°æ® } = await è§£æVLæ ‡å¤´(è§£å¯†æ•°æ®); //è§£æVLæ•°æ®å¹¶è¿›è¡ŒTCPæ¡æ‰‹
  å»ºç«‹ä¼ è¾“ç®¡é“(WSæ¥å£, TCPæ¥å£, å†™å…¥åˆå§‹æ•°æ®);
  return new Response(null, { status: 101, webSocket: å®¢æˆ·ç«¯ });
}
function ä½¿ç”¨64ä½åŠ è§£å¯†(è¿˜åŸæ··æ·†å­—ç¬¦) {
  è¿˜åŸæ··æ·†å­—ç¬¦ = è¿˜åŸæ··æ·†å­—ç¬¦.replace(/-/g, '+').replace(/_/g, '/');
  const è§£å¯†æ•°æ® = atob(è¿˜åŸæ··æ·†å­—ç¬¦);
  const è§£å¯†_ä½ _ä¸ª_ä¸å’š_å’™_å’šå‘› = Uint8Array.from(è§£å¯†æ•°æ®, (c) => c.charCodeAt(0));
  return è§£å¯†_ä½ _ä¸ª_ä¸å’š_å’™_å’šå‘›.buffer;
}
//ç¬¬äºŒæ­¥ï¼Œè§£è¯»VLåè®®æ•°æ®ï¼Œåˆ›å»ºTCPæ¡æ‰‹
async function è§£æVLæ ‡å¤´(VLæ•°æ®, TCPæ¥å£) {
  if (!ç§é’¥å¼€å…³ && éªŒè¯VLçš„å¯†é’¥(new Uint8Array(VLæ•°æ®.slice(1, 17))) !== å“å‘€å‘€è¿™æ˜¯æˆ‘çš„VLå¯†é’¥) {
    return null;
  }
  const è·å–æ•°æ®å®šä½ = new Uint8Array(VLæ•°æ®)[17];
  const æå–ç«¯å£ç´¢å¼• = 18 + è·å–æ•°æ®å®šä½ + 1;
  const å»ºç«‹ç«¯å£ç¼“å­˜ = VLæ•°æ®.slice(æå–ç«¯å£ç´¢å¼•, æå–ç«¯å£ç´¢å¼• + 2);
  const è®¿é—®ç«¯å£ = new DataView(å»ºç«‹ç«¯å£ç¼“å­˜).getUint16(0);
  const æå–åœ°å€ç´¢å¼• = æå–ç«¯å£ç´¢å¼• + 2;
  const å»ºç«‹åœ°å€ç¼“å­˜ = new Uint8Array(VLæ•°æ®.slice(æå–åœ°å€ç´¢å¼•, æå–åœ°å€ç´¢å¼• + 1));
  const è¯†åˆ«åœ°å€ç±»å‹ = å»ºç«‹åœ°å€ç¼“å­˜[0];
  let åœ°å€é•¿åº¦ = 0;
  let è®¿é—®åœ°å€ = '';
  let åœ°å€ä¿¡æ¯ç´¢å¼• = æå–åœ°å€ç´¢å¼• + 1;
  switch (è¯†åˆ«åœ°å€ç±»å‹) {
    case 1:
      åœ°å€é•¿åº¦ = 4;
      è®¿é—®åœ°å€ = new Uint8Array( VLæ•°æ®.slice(åœ°å€ä¿¡æ¯ç´¢å¼•, åœ°å€ä¿¡æ¯ç´¢å¼• + åœ°å€é•¿åº¦) ).join('.');
      break;
    case 2:
      åœ°å€é•¿åº¦ = new Uint8Array( VLæ•°æ®.slice(åœ°å€ä¿¡æ¯ç´¢å¼•, åœ°å€ä¿¡æ¯ç´¢å¼• + 1) )[0];
      åœ°å€ä¿¡æ¯ç´¢å¼• += 1;
      è®¿é—®åœ°å€ = new TextDecoder().decode( VLæ•°æ®.slice(åœ°å€ä¿¡æ¯ç´¢å¼•, åœ°å€ä¿¡æ¯ç´¢å¼• + åœ°å€é•¿åº¦) );
      break;
    case 3:
      åœ°å€é•¿åº¦ = 16;
      const dataView = new DataView( VLæ•°æ®.slice(åœ°å€ä¿¡æ¯ç´¢å¼•, åœ°å€ä¿¡æ¯ç´¢å¼• + åœ°å€é•¿åº¦) );
      const ipv6 = [];
      for (let i = 0; i < 8; i++) { ipv6.push(dataView.getUint16(i * 2).toString(16)); }
      è®¿é—®åœ°å€ = ipv6.join(':');
      break;
  }
  const å†™å…¥åˆå§‹æ•°æ® = VLæ•°æ®.slice(åœ°å€ä¿¡æ¯ç´¢å¼• + åœ°å€é•¿åº¦);
  if (å¯ç”¨åä»£åŠŸèƒ½ && å¯ç”¨SOCKS5åä»£ && å¯ç”¨SOCKS5å…¨å±€åä»£) {
    TCPæ¥å£ = await åˆ›å»ºSOCKS5æ¥å£(è¯†åˆ«åœ°å€ç±»å‹, è®¿é—®åœ°å€, è®¿é—®ç«¯å£);
    return { TCPæ¥å£, å†™å…¥åˆå§‹æ•°æ® };
  } else {
    try {
    TCPæ¥å£ = connect({ hostname: è®¿é—®åœ°å€, port: è®¿é—®ç«¯å£ });
    await TCPæ¥å£.opened;
    } catch {
      if (å¯ç”¨åä»£åŠŸèƒ½) {
        if (å¯ç”¨SOCKS5åä»£) {
          TCPæ¥å£ = await åˆ›å»ºSOCKS5æ¥å£(è¯†åˆ«åœ°å€ç±»å‹, è®¿é—®åœ°å€, è®¿é—®ç«¯å£);
        } else {
          let [åä»£IPåœ°å€, åä»£IPç«¯å£] = åä»£IP.split(':');
          TCPæ¥å£ = connect({ hostname: åä»£IPåœ°å€, port: åä»£IPç«¯å£ || è®¿é—®ç«¯å£ });
        }
      }
    } finally {
      return { TCPæ¥å£, å†™å…¥åˆå§‹æ•°æ® };
    }
  }
}
function éªŒè¯VLçš„å¯†é’¥(arr, offset = 0) {
  const uuid = (è½¬æ¢å¯†é’¥æ ¼å¼[arr[offset + 0]] + è½¬æ¢å¯†é’¥æ ¼å¼[arr[offset + 1]] + è½¬æ¢å¯†é’¥æ ¼å¼[arr[offset + 2]] + è½¬æ¢å¯†é’¥æ ¼å¼[arr[offset + 3]] + "-" + è½¬æ¢å¯†é’¥æ ¼å¼[arr[offset + 4]] + è½¬æ¢å¯†é’¥æ ¼å¼[arr[offset + 5]] + "-" + è½¬æ¢å¯†é’¥æ ¼å¼[arr[offset + 6]] + è½¬æ¢å¯†é’¥æ ¼å¼[arr[offset + 7]] + "-" + è½¬æ¢å¯†é’¥æ ¼å¼[arr[offset + 8]] + è½¬æ¢å¯†é’¥æ ¼å¼[arr[offset + 9]] + "-" + è½¬æ¢å¯†é’¥æ ¼å¼[arr[offset + 10]] + è½¬æ¢å¯†é’¥æ ¼å¼[arr[offset + 11]] + è½¬æ¢å¯†é’¥æ ¼å¼[arr[offset + 12]] + è½¬æ¢å¯†é’¥æ ¼å¼[arr[offset + 13]] + è½¬æ¢å¯†é’¥æ ¼å¼[arr[offset + 14]] + è½¬æ¢å¯†é’¥æ ¼å¼[arr[offset + 15]]).toLowerCase();
  return uuid;
}
const è½¬æ¢å¯†é’¥æ ¼å¼ = [];
for (let i = 0; i < 256; ++i) { è½¬æ¢å¯†é’¥æ ¼å¼.push((i + 256).toString(16).slice(1)); }
//ç¬¬ä¸‰æ­¥ï¼Œåˆ›å»ºå®¢æˆ·ç«¯WS-CF-ç›®æ ‡çš„ä¼ è¾“é€šé“å¹¶ç›‘å¬çŠ¶æ€
async function å»ºç«‹ä¼ è¾“ç®¡é“(WSæ¥å£, TCPæ¥å£, å†™å…¥åˆå§‹æ•°æ®, TCPç¼“å­˜ = [], WSç¼“å­˜ = []) {
  await WSæ¥å£.send(new Uint8Array([0, 0]).buffer);
  const æ•°æ®æµ = new ReadableStream({ //ç›‘å¬WSæ¥å£æ•°æ®å¹¶å‘é€ç»™æ•°æ®æµ
    async start(æ§åˆ¶å™¨) {
      if (å†™å…¥åˆå§‹æ•°æ®) { æ§åˆ¶å™¨.enqueue(å†™å…¥åˆå§‹æ•°æ®) };
      WSæ¥å£.addEventListener('message', (event) => { æ§åˆ¶å™¨.enqueue(event.data) }); //ç›‘å¬å®¢æˆ·ç«¯WSæ¥å£æ¶ˆæ¯ï¼Œæ¨é€ç»™æ•°æ®æµ
      WSæ¥å£.addEventListener('close', () => { æ§åˆ¶å™¨.close(); TCPæ¥å£.close(); setTimeout(() => WSæ¥å£.close(1000), 2) }); //ç›‘å¬å®¢æˆ·ç«¯WSæ¥å£å…³é—­ä¿¡æ¯ï¼Œç»“æŸæµä¼ è¾“
      WSæ¥å£.addEventListener('error', () => { æ§åˆ¶å™¨.close(); TCPæ¥å£.close(); setTimeout(() => WSæ¥å£.close(1001), 2) }); //ç›‘å¬å®¢æˆ·ç«¯WSæ¥å£å¼‚å¸¸ä¿¡æ¯ï¼Œç»“æŸæµä¼ è¾“
    }
  });
  Promise.allSettled(Array.from({ length: TCPå¹¶å‘æ•° }, () => //å°†å®¢æˆ·ç«¯æ¥æ”¶åˆ°çš„WSæ•°æ®å‘å¾€TCPæ¥å£
    æ•°æ®æµ.pipeTo(new WritableStream({ 
      async write(VLæ•°æ®) {
        const ä¼ è¾“æ•°æ® = TCPæ¥å£.writable.getWriter();
        if (å¯ç”¨æœ¬åœ°ç¼“å­˜) {
          await TCPç¼“å­˜.push(VLæ•°æ®);
          let æ•°æ®å— = TCPç¼“å­˜.shift();
          await ä¼ è¾“æ•°æ®.write(æ•°æ®å—);
        } else {
          await ä¼ è¾“æ•°æ®.write(VLæ•°æ®);
        }
        ä¼ è¾“æ•°æ®.releaseLock();
        await new Promise(resolve => setTimeout(resolve, é™é€Ÿç­‰çº§));
      }
    }))
  ));
  TCPæ¥å£.readable.pipeTo(new WritableStream({ //å°†TCPæ¥å£è¿”å›çš„æ•°æ®é€šè¿‡WSæ¥å£å‘é€å›å®¢æˆ·ç«¯
    async write(VLæ•°æ®) {
      if (å¯ç”¨æœ¬åœ°ç¼“å­˜) {
        await WSç¼“å­˜.push(VLæ•°æ®);
        let æ•°æ®å— = WSç¼“å­˜.shift();
        await WSæ¥å£.send(æ•°æ®å—);
      } else {
        await WSæ¥å£.send(VLæ•°æ®);
      }
      await new Promise(resolve => setTimeout(resolve, é™é€Ÿç­‰çº§));
    }
  }));
}
//////////////////////////////////////////////////////////////////////////SOCKS5éƒ¨åˆ†//////////////////////////////////////////////////////////////////////
async function åˆ›å»ºSOCKS5æ¥å£(è¯†åˆ«åœ°å€ç±»å‹, è®¿é—®åœ°å€, è®¿é—®ç«¯å£) {
  const { username, password, hostname, port } = await è·å–SOCKS5è´¦å·(æˆ‘çš„SOCKS5è´¦å·);
  const SOCKS5æ¥å£ = connect({ hostname, port });
  try {
    await SOCKS5æ¥å£.opened;
  } catch {
    return new Response('SOCKS5æœªè¿é€š', { status: 400 });
  }
  const writer = SOCKS5æ¥å£.writable.getWriter();
  const reader = SOCKS5æ¥å£.readable.getReader();
  const encoder = new TextEncoder();
  const socksGreeting = new Uint8Array([5, 2, 0, 2]); //æ„å»ºè®¤è¯ä¿¡æ¯,æ”¯æŒæ— è®¤è¯å’Œç”¨æˆ·å/å¯†ç è®¤è¯
  await writer.write(socksGreeting);
  let res = (await reader.read()).value;
  if (res[1] === 0x02) { //æ£€æŸ¥æ˜¯å¦éœ€è¦ç”¨æˆ·å/å¯†ç è®¤è¯
    if (!username || !password) {
      return å…³é—­æ¥å£å¹¶é€€å‡º();
    }
    const authRequest = new Uint8Array([ 1, username.length, ...encoder.encode(username), password.length, ...encoder.encode(password) ]); // å‘é€ç”¨æˆ·å/å¯†ç è®¤è¯è¯·æ±‚
    await writer.write(authRequest);
    res = (await reader.read()).value;
    if (res[0] !== 0x01 || res[1] !== 0x00) {
      return å…³é—­æ¥å£å¹¶é€€å‡º(); // è®¤è¯å¤±è´¥
    }
  }
  let è½¬æ¢è®¿é—®åœ°å€;
  switch (è¯†åˆ«åœ°å€ç±»å‹) {
    case 1: // IPv4
      è½¬æ¢è®¿é—®åœ°å€ = new Uint8Array( [1, ...è®¿é—®åœ°å€.split('.').map(Number)] );
      break;
    case 2: // åŸŸå
      è½¬æ¢è®¿é—®åœ°å€ = new Uint8Array( [3, è®¿é—®åœ°å€.length, ...encoder.encode(è®¿é—®åœ°å€)] );
      break;
    case 3: // IPv6
      è½¬æ¢è®¿é—®åœ°å€ = new Uint8Array( [4, ...è®¿é—®åœ°å€.split(':').flatMap(x => [parseInt(x.slice(0, 2), 16), parseInt(x.slice(2), 16)])] );
      break;
    default:
      return å…³é—­æ¥å£å¹¶é€€å‡º();
  }
  const socksRequest = new Uint8Array([ 5, 1, 0, ...è½¬æ¢è®¿é—®åœ°å€, è®¿é—®ç«¯å£ >> 8, è®¿é—®ç«¯å£ & 0xff ]); //å‘é€è½¬æ¢åçš„è®¿é—®åœ°å€/ç«¯å£
  await writer.write(socksRequest);
  res = (await reader.read()).value;
  if (res[0] !== 0x05 || res[1] !== 0x00) {
    return å…³é—­æ¥å£å¹¶é€€å‡º(); // è¿æ¥å¤±è´¥
  }
  writer.releaseLock();
  reader.releaseLock();
  return SOCKS5æ¥å£;
  function å…³é—­æ¥å£å¹¶é€€å‡º() {
    writer.releaseLock();
    reader.releaseLock();
    SOCKS5æ¥å£.close();
    return new Response('SOCKS5æ¡æ‰‹å¤±è´¥', { status: 400 });
  }
}
async function è·å–SOCKS5è´¦å·(SOCKS5) {
  const [latter, former] = SOCKS5.split("@").reverse();
  let username, password, hostname, port;
  if (former) {
    const formers = former.split(":");
    username = formers[0];
    password = formers[1];
  }
  const latters = latter.split(":");
  port = Number(latters.pop());
  hostname = latters.join(":");
  return { username, password, hostname, port };
}
//////////////////////////////////////////////////////////////////////////è®¢é˜…é¡µé¢////////////////////////////////////////////////////////////////////////
let è½¬ç  = 'vl', è½¬ç 2 = 'ess', ç¬¦å· = '://', å°çŒ« = 'cla', å’ª = 'sh', æˆ‘çš„ç§é’¥;
if (ç§é’¥å¼€å…³) {
  æˆ‘çš„ç§é’¥ = `my-key: ${å’¦è¿™æ˜¯æˆ‘çš„ç§é’¥å“}`
} else {
  æˆ‘çš„ç§é’¥ = ""
}
function ç»™æˆ‘è®¢é˜…é¡µé¢(å“å‘€å‘€è¿™æ˜¯æˆ‘çš„IDå•Š, hostName) {
return `
 <!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è®¢é˜…ç”Ÿæˆé¡µé¢</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      color: #333;
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: #4CAF50;
    }
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .link {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background: #f9f9f9;
    }
    .button {
      background-color: #4CAF50;
      border: none;
      color: white;
      padding: 10px 20px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 14px;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s;
    }
    .button:hover {
      background-color: #45a049;
    }
    .code {
      font-family: monospace;
      font-size: 14px;
      color: #555;
      flex-grow: 1;
      margin-right: 10px;
    }
    .tg-button {
      display: block;
      text-align: center;
      margin-top: 20px;
    }
    .tg-button a {
      background-color: #0088cc;
      color: white;
      padding: 10px 20px;
      text-decoration: none;
      border-radius: 5px;
      font-size: 16px;
      transition: background-color 0.3s;
    }
    .tg-button a:hover {
      background-color: #0077aa;
    }
  </style>
</head>
<body>
  <h1>è®¢é˜…ç”Ÿæˆé¡µé¢</h1>
  <div class="container">
    <div class="link">
      <span class="code">https${ç¬¦å·}${hostName}/${å“å‘€å‘€è¿™æ˜¯æˆ‘çš„IDå•Š}/clash</span>
      <button class="button" onclick="copyToClipboard('https${ç¬¦å·}${hostName}/${å“å‘€å‘€è¿™æ˜¯æˆ‘çš„IDå•Š}/vless')">å¤åˆ¶é“¾æ¥</button>
    </div>
    <div class="link">
      <span class="code">https${ç¬¦å·}${hostName}/${å“å‘€å‘€è¿™æ˜¯æˆ‘çš„IDå•Š}/${å°çŒ«}${å’ª}</span>
      <button class="button" onclick="copyToClipboard('https${ç¬¦å·}${hostName}/${å“å‘€å‘€è¿™æ˜¯æˆ‘çš„IDå•Š}/clash')">å¤åˆ¶é“¾æ¥</button>
    </div>
    <div class="tg-button">
      <a href="https://t.me/ä½ çš„Telegramç”¨æˆ·å" target="_blank">è”ç³» Telegram</a>
    </div>
  </div>

  <script>
    // å¤åˆ¶åˆ°å‰ªè´´æ¿åŠŸèƒ½
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert('å¤åˆ¶æˆåŠŸï¼' );
      }).catch(err => {
        console.error('å¤åˆ¶å¤±è´¥ï¼', err);
      });
    }
  </script>
</body>
</html>

    

`;
}
function ç»™æˆ‘é€šç”¨é…ç½®æ–‡ä»¶(hostName) {
  if (æˆ‘çš„ä¼˜é€‰.length === 0) {
    æˆ‘çš„ä¼˜é€‰ = [`${hostName}:443`];
  }

  if (ç§é’¥å¼€å…³) {
    return `è¯·å…ˆå…³é—­ç§é’¥åŠŸèƒ½`;
  } else {
    const è®¢é˜…å†…å®¹ = æˆ‘çš„ä¼˜é€‰.map(è·å–ä¼˜é€‰ => {
      const [ä¸»å†…å®¹, tls] = è·å–ä¼˜é€‰.split("@");
      const [åœ°å€ç«¯å£, èŠ‚ç‚¹åå­— = æˆ‘çš„èŠ‚ç‚¹åå­—] = ä¸»å†…å®¹.split("#");
      const æ‹†åˆ†åœ°å€ç«¯å£ = åœ°å€ç«¯å£.split(":");
      const ç«¯å£ = æ‹†åˆ†åœ°å€ç«¯å£.length > 1 ? Number(æ‹†åˆ†åœ°å€ç«¯å£.pop()) : 443;
      const åœ°å€ = æ‹†åˆ†åœ°å€ç«¯å£.join(":");
      const TLSå¼€å…³ = tls === 'notls' ? 'security=none' : 'security=tls';
      
      // ç”Ÿæˆå®Œæ•´çš„èŠ‚ç‚¹é…ç½®
      return `${è½¬ç }${è½¬ç 2}${ç¬¦å·}${å“å‘€å‘€è¿™æ˜¯æˆ‘çš„VLå¯†é’¥}@${åœ°å€}:${ç«¯å£}?encryption=none&${TLSå¼€å…³}&sni=${hostName}&type=ws&host=${hostName}&path=%2F%3Fed%3D2560#${èŠ‚ç‚¹åå­—}`;
    }).join("\n");

  }
}

function ç»™æˆ‘å°çŒ«å’ªé…ç½®æ–‡ä»¶(hostName) {
if (æˆ‘çš„ä¼˜é€‰.length === 0){
  æˆ‘çš„ä¼˜é€‰ = [`${hostName}:443`]
}
const ç”ŸæˆèŠ‚ç‚¹ = (æˆ‘çš„ä¼˜é€‰) => {
  return æˆ‘çš„ä¼˜é€‰.map(è·å–ä¼˜é€‰ => {
    const [ä¸»å†…å®¹,tls] = è·å–ä¼˜é€‰.split("@");
    const [åœ°å€ç«¯å£, èŠ‚ç‚¹åå­— = æˆ‘çš„èŠ‚ç‚¹åå­—] = ä¸»å†…å®¹.split("#");
    const æ‹†åˆ†åœ°å€ç«¯å£ = åœ°å€ç«¯å£.split(":");
    const ç«¯å£ =æ‹†åˆ†åœ°å€ç«¯å£.length > 1 ? Number(æ‹†åˆ†åœ°å€ç«¯å£.pop()) : 443;
    const åœ°å€ = æ‹†åˆ†åœ°å€ç«¯å£.join(":").replace(/^\[(.+)\]$/, '$1');
    const TLSå¼€å…³ = tls === 'notls' ? 'false' : 'true';
  return {
    nodeConfig: `- name: ${èŠ‚ç‚¹åå­—}
  type: ${è½¬ç }${è½¬ç 2}
  server: ${åœ°å€}
  port: ${ç«¯å£}
  uuid: ${å“å‘€å‘€è¿™æ˜¯æˆ‘çš„VLå¯†é’¥}
  udp: false
  tls: ${TLSå¼€å…³}
  sni: ${hostName}
  network: ws
  ws-opts:
    path: "/?ed=2560"
    headers:
      Host: ${hostName}
      ${æˆ‘çš„ç§é’¥}`,
    proxyConfig: `    - ${èŠ‚ç‚¹åå­—}`
    };
  });
};
const èŠ‚ç‚¹é…ç½® = ç”ŸæˆèŠ‚ç‚¹(æˆ‘çš„ä¼˜é€‰).map(node => node.nodeConfig).join("\n");
const ä»£ç†é…ç½® = ç”ŸæˆèŠ‚ç‚¹(æˆ‘çš„ä¼˜é€‰).map(node => node.proxyConfig).join("\n");
return `
dns:
  nameserver:
    - 180.76.76.76
    - 2400:da00::6666
  fallback:
    - 8.8.8.8
    - 2001:4860:4860::8888
proxies:
${èŠ‚ç‚¹é…ç½®}
proxy-groups:
- name: ğŸš€ èŠ‚ç‚¹é€‰æ‹©
  type: select
  proxies:
    - è‡ªåŠ¨é€‰æ‹©
${ä»£ç†é…ç½®}
- name: è‡ªåŠ¨é€‰æ‹©
  type: url-test
  url: http://www.gstatic.com/generate_204
  interval: 60 #æµ‹è¯•é—´éš”
  tolerance: 30
  proxies:
${ä»£ç†é…ç½®}
- name: æ¼ç½‘ä¹‹é±¼
  type: select
  proxies:
    - DIRECT
    - ğŸš€ èŠ‚ç‚¹é€‰æ‹©
rules: # æœ¬äººè‡ªç”¨è§„åˆ™ï¼Œä¸ä¸€å®šé€‚åˆæ‰€æœ‰äººæ‰€æœ‰å®¢æˆ·ç«¯ï¼Œå¦‚å®¢æˆ·ç«¯å› è§„åˆ™é—®é¢˜æ— æ³•è®¢é˜…å°±åˆ é™¤å¯¹åº”è§„åˆ™å§ï¼Œæ¯ä¸ªäººéƒ½æœ‰è‡ªå·±ä¹ æƒ¯çš„è§„åˆ™ï¼Œè‡ªè¡Œç ”ç©¶å“¦
# ç­–ç•¥è§„åˆ™ï¼Œå»ºè®®ä½¿ç”¨metaå†…æ ¸ï¼Œéƒ¨åˆ†è§„åˆ™éœ€æ‰“å¼€${å°çŒ«}${å’ª} mateçš„ä½¿ç”¨geoip datç‰ˆæ•°æ®åº“ï¼Œæ¯”å¦‚TGè§„åˆ™å°±éœ€è¦ï¼Œæˆ–è€…è‡ªå®šä¹‰geoipçš„è§„åˆ™è®¢é˜…
# è¿™æ˜¯geoipçš„è§„åˆ™è®¢é˜…é“¾æ¥ï¼Œhttps://cdn.jsdelivr.net/gh/Loyalsoldier/geoip@release/Country.mmdb
# - GEOSITE,category-ads-all,REJECT #ç®€å•å¹¿å‘Šè¿‡æ»¤è§„åˆ™ï¼Œè¦å¢åŠ è§„åˆ™æ•°å¯ä½¿ç”¨category-ads-all
- GEOSITE,cn,DIRECT #å›½å†…åŸŸåç›´è¿è§„åˆ™
- GEOIP,CN,DIRECT,no-resolve #å›½å†…IPç›´è¿è§„åˆ™
- GEOSITE,cloudflare,DIRECT #CFåŸŸåç›´è¿è§„åˆ™
- GEOIP,CLOUDFLARE,DIRECT,no-resolve #CFIPç›´è¿è§„åˆ™
- GEOSITE,gfw,ğŸš€ èŠ‚ç‚¹é€‰æ‹© #GFWåŸŸåè§„åˆ™
- GEOSITE,google,ğŸš€ èŠ‚ç‚¹é€‰æ‹© #GOOGLEåŸŸåè§„åˆ™
- GEOIP,GOOGLE,ğŸš€ èŠ‚ç‚¹é€‰æ‹©,no-resolve #GOOGLE IPè§„åˆ™
- GEOSITE,netflix,ğŸš€ èŠ‚ç‚¹é€‰æ‹© #å¥ˆé£åŸŸåè§„åˆ™
- GEOIP,NETFLIX,ğŸš€ èŠ‚ç‚¹é€‰æ‹©,no-resolve #å¥ˆé£IPè§„åˆ™
- GEOSITE,telegram,ğŸš€ èŠ‚ç‚¹é€‰æ‹© #TGåŸŸåè§„åˆ™
- GEOIP,TELEGRAM,ğŸš€ èŠ‚ç‚¹é€‰æ‹©,no-resolve #TG IPè§„åˆ™
- GEOSITE,openai,ğŸš€ èŠ‚ç‚¹é€‰æ‹© #GPTè§„åˆ™
- MATCH,æ¼ç½‘ä¹‹é±¼
`
}
